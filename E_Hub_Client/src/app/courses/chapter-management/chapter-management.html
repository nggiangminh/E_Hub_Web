<!-- Chapter Management Template -->
<div class="chapter-management-container">
  <!-- Decorative Elements -->
  <div class="geometric-decoration decoration-1"></div>
  <div class="geometric-decoration decoration-2"></div>
  <div class="geometric-decoration decoration-3"></div>

  <!-- Header -->
  <div class="management-header">
    <div class="header-navigation">
      <button type="button" class="back-button" [routerLink]="['/courses', courseId]">
        <span class="back-icon">‚Üê</span>
        <span class="back-text">Quay l·∫°i kh√≥a h·ªçc</span>
      </button>
    </div>
    
    <div class="header-info" *ngIf="courseTitle">
      <h1 class="page-title">üìö Qu·∫£n l√Ω ch∆∞∆°ng h·ªçc</h1>
      <p class="course-title">{{ courseTitle }}</p>
    </div>

    <div class="header-actions">
      <button type="button" 
              class="btn btn-primary"
              (click)="openChapterModal()">
        <span class="btn-icon">‚ûï</span>
        Th√™m ch∆∞∆°ng m·ªõi
      </button>
    </div>
  </div>

  <!-- Chapter Statistics -->
  <div class="statistics-section" *ngIf="!isLoading">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üìñ</div>
        <div class="stat-info">
          <div class="stat-number">{{ chapters.length }}</div>
          <div class="stat-label">Ch∆∞∆°ng h·ªçc</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">üéØ</div>
        <div class="stat-info">
          <div class="stat-number">{{ totalLessons }}</div>
          <div class="stat-label">T·ªïng b√†i h·ªçc</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-info">
          <div class="stat-number">{{ publishedChapters }}</div>
          <div class="stat-label">ƒê√£ xu·∫•t b·∫£n</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">‚è±Ô∏è</div>
        <div class="stat-info">
          <div class="stat-number">{{ totalDurationFormatted }}</div>
          <div class="stat-label">Th·ªùi l∆∞·ª£ng</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chapters List -->
  <div class="chapters-section" *ngIf="!isLoading">
    <div class="section-header">
      <h2 class="section-title">üìã Danh s√°ch ch∆∞∆°ng</h2>
      <div class="section-actions">
        <button type="button" 
                class="btn btn-secondary"
                (click)="reorderMode = !reorderMode">
          <span class="btn-icon">{{ reorderMode ? '‚úÖ' : 'üîÑ' }}</span>
          {{ reorderMode ? 'Ho√†n t·∫•t' : 'S·∫Øp x·∫øp' }}
        </button>
      </div>
    </div>

    <!-- Reorder Instructions -->
    <div class="reorder-notice" *ngIf="reorderMode">
      <span class="notice-icon">‚ÑπÔ∏è</span>
      <span class="notice-text">K√©o th·∫£ c√°c ch∆∞∆°ng ƒë·ªÉ s·∫Øp x·∫øp l·∫°i th·ª© t·ª±</span>
    </div>

    <!-- Chapters List Container -->
    <div class="chapters-list" 
         [class.reorder-mode]="reorderMode">
      
      <div *ngFor="let chapter of chapters; let i = index; trackBy: trackByChapterId" 
           class="chapter-item"
           [class.reorder-item]="reorderMode"
           [attr.data-chapter-id]="chapter.id">
        
        <!-- Reorder Handle -->
        <div class="reorder-handle" *ngIf="reorderMode">
          <span class="handle-icon">‚ãÆ‚ãÆ</span>
        </div>

        <!-- Chapter Content -->
        <div class="chapter-content">
          <div class="chapter-header">
            <div class="chapter-main-info">
              <div class="chapter-number">{{ i + 1 }}</div>
              <div class="chapter-details">
                <h3 class="chapter-title">{{ chapter.title }}</h3>
                <p class="chapter-description" *ngIf="chapter.description">
                  {{ chapter.description }}
                </p>
                
                <div class="chapter-meta">
                  <span class="meta-item">
                    <span class="meta-icon">üéØ</span>
                    <span class="meta-text">{{ getChapterLessonCount(chapter.id) }} b√†i h·ªçc</span>
                  </span>
                  
                  <span class="meta-item">
                    <span class="meta-icon">‚è±Ô∏è</span>
                    <span class="meta-text">{{ getChapterDuration(chapter.id) }}</span>
                  </span>
                  
                  <span class="meta-item">
                    <span class="meta-icon">üìÖ</span>
                    <span class="meta-text">{{ formatDate(chapter.updatedAt) }}</span>
                  </span>
                </div>
              </div>
            </div>

            <!-- Chapter Actions -->
            <div class="chapter-actions" *ngIf="!reorderMode">
              <button type="button" 
                      class="action-btn view-btn"
                      (click)="viewChapterLessons(chapter)"
                      title="Xem b√†i h·ªçc">
                üëÅÔ∏è
              </button>
              
              <button type="button" 
                      class="action-btn edit-btn"
                      (click)="editChapter(chapter)"
                      title="Ch·ªânh s·ª≠a">
                ‚úèÔ∏è
              </button>
              
              <button type="button" 
                      class="action-btn delete-btn"
                      (click)="deleteChapter(chapter)"
                      title="X√≥a ch∆∞∆°ng">
                üóëÔ∏è
              </button>
            </div>
          </div>

          <!-- Chapter Lessons Preview -->
          <div class="lessons-preview" 
               *ngIf="expandedChapters.has(chapter.id) && getChapterLessons(chapter.id).length > 0">
            
            <div class="lessons-header">
              <h4 class="lessons-title">B√†i h·ªçc trong ch∆∞∆°ng</h4>
              <button type="button" 
                      class="btn btn-small btn-secondary"
                      (click)="manageLessons(chapter)">
                Qu·∫£n l√Ω b√†i h·ªçc
              </button>
            </div>

            <div class="lessons-list">
              <div *ngFor="let lesson of getChapterLessons(chapter.id); let lessonIndex = index" 
                   class="lesson-item">
                
                <div class="lesson-info">
                  <div class="lesson-type-icon" [class]="'type-' + lesson.lessonType.toLowerCase()">
                    {{ getLessonTypeIcon(lesson.lessonType) }}
                  </div>
                  
                  <div class="lesson-details">
                    <span class="lesson-title">{{ lesson.title }}</span>
                    <div class="lesson-meta">
                      <span class="lesson-type">{{ getLessonTypeDisplay(lesson.lessonType) }}</span>
                      <span class="lesson-duration" *ngIf="lesson.durationSeconds">
                        {{ formatDuration(lesson.durationSeconds) }}
                      </span>
                      <span class="lesson-status" [class]="lesson.published ? 'published' : 'draft'">
                        {{ lesson.published ? 'ƒê√£ xu·∫•t b·∫£n' : 'Nh√°p' }}
                      </span>
                    </div>
                  </div>
                </div>

                <div class="lesson-actions">
                  <button type="button" 
                          class="lesson-action-btn"
                          title="Ch·ªânh s·ª≠a b√†i h·ªçc">
                    ‚úèÔ∏è
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Expand/Collapse Toggle -->
          <div class="chapter-toggle" *ngIf="!reorderMode && getChapterLessons(chapter.id).length > 0">
            <button type="button" 
                    class="toggle-btn"
                    (click)="toggleChapterExpansion(chapter.id)">
              <span class="toggle-icon" [class.expanded]="expandedChapters.has(chapter.id)">
                ‚ñº
              </span>
              <span class="toggle-text">
                {{ expandedChapters.has(chapter.id) ? 'Thu g·ªçn' : 'Xem b√†i h·ªçc' }}
              </span>
            </button>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="chapters.length === 0" class="empty-state">
        <div class="empty-icon">üìö</div>
        <h3 class="empty-title">Ch∆∞a c√≥ ch∆∞∆°ng n√†o</h3>
        <p class="empty-description">
          B·∫Øt ƒë·∫ßu t·∫°o ch∆∞∆°ng ƒë·∫ßu ti√™n cho kh√≥a h·ªçc c·ªßa b·∫°n
        </p>
        <button type="button" 
                class="btn btn-primary btn-large"
                (click)="openChapterModal()">
          <span class="btn-icon">‚ûï</span>
          T·∫°o ch∆∞∆°ng ƒë·∫ßu ti√™n
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text">ƒêang t·∫£i danh s√°ch ch∆∞∆°ng...</p>
  </div>
</div>

<!-- Chapter Modal -->
<div *ngIf="showChapterModal" class="modal-overlay" (click)="closeChapterModal()">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        {{ editingChapter ? '‚úèÔ∏è Ch·ªânh s·ª≠a ch∆∞∆°ng' : '‚ûï Th√™m ch∆∞∆°ng m·ªõi' }}
      </h2>
      <button type="button" class="close-btn" (click)="closeChapterModal()">‚úï</button>
    </div>
    
    <form class="chapter-form" (ngSubmit)="saveChapter()" #chapterForm="ngForm">
      <div class="modal-body">
        <!-- Chapter Title -->
        <div class="form-group">
          <label for="chapterTitle" class="form-label">Ti√™u ƒë·ªÅ ch∆∞∆°ng *</label>
          <input type="text" 
                 id="chapterTitle"
                 name="chapterTitle"
                 class="form-input"
                 [(ngModel)]="chapterFormData.title"
                 #titleInput="ngModel"
                 required
                 maxlength="200"
                 placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ch∆∞∆°ng">
          <div class="form-error" *ngIf="titleInput.invalid && titleInput.touched">
            <span *ngIf="titleInput.errors?.['required']">Ti√™u ƒë·ªÅ ch∆∞∆°ng l√† b·∫Øt bu·ªôc</span>
            <span *ngIf="titleInput.errors?.['maxlength']">Ti√™u ƒë·ªÅ kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 200 k√Ω t·ª±</span>
          </div>
          <div class="char-count">{{ chapterFormData.title.length }}/200</div>
        </div>

        <!-- Chapter Description -->
        <div class="form-group">
          <label for="chapterDescription" class="form-label">M√¥ t·∫£ ch∆∞∆°ng</label>
          <textarea id="chapterDescription"
                    name="chapterDescription"
                    class="form-textarea"
                    [(ngModel)]="chapterFormData.description"
                    maxlength="500"
                    rows="4"
                    placeholder="M√¥ t·∫£ n·ªôi dung ch∆∞∆°ng h·ªçc (t√πy ch·ªçn)"></textarea>
          <div class="char-count">{{ chapterFormData.description.length }}/500</div>
        </div>

        <!-- Chapter Order -->
        <div class="form-group" *ngIf="!editingChapter">
          <label for="chapterOrder" class="form-label">V·ªã tr√≠ ch∆∞∆°ng</label>
          <select id="chapterOrder"
                  name="chapterOrder"
                  class="form-select"
                  [(ngModel)]="chapterFormData.orderIndex">
            <option value="">Ch·ªçn v·ªã tr√≠ (m·∫∑c ƒë·ªãnh: cu·ªëi danh s√°ch)</option>
            <option *ngFor="let position of getAvailablePositions(); let i = index" 
                    [value]="i + 1">
              V·ªã tr√≠ {{ i + 1 }}{{ i === 0 ? ' (ƒë·∫ßu danh s√°ch)' : i === getAvailablePositions().length - 1 ? ' (cu·ªëi danh s√°ch)' : '' }}
            </option>
          </select>
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="button" 
                class="btn btn-outline" 
                (click)="closeChapterModal()">
          H·ªßy
        </button>
        <button type="submit" 
                class="btn btn-primary"
                [disabled]="!chapterForm.valid || isSubmitting">
          <span class="btn-icon">{{ editingChapter ? 'üíæ' : '‚ûï' }}</span>
          {{ editingChapter ? 'C·∫≠p nh·∫≠t' : 'T·∫°o ch∆∞∆°ng' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteModal" class="modal-overlay" (click)="showDeleteModal = false">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header danger">
      <h2 class="modal-title">üóëÔ∏è X√°c nh·∫≠n x√≥a</h2>
      <button type="button" class="close-btn" (click)="showDeleteModal = false">‚úï</button>
    </div>
    
    <div class="modal-body">
      <p class="delete-warning">
        B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng <strong>"{{ chapterToDelete?.title }}"</strong>?
      </p>
      <p class="delete-note">
        ‚ö†Ô∏è Thao t√°c n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn ch∆∞∆°ng v√† t·∫•t c·∫£ b√†i h·ªçc b√™n trong. Kh√¥ng th·ªÉ ho√†n t√°c!
      </p>
    </div>
    
    <div class="modal-actions">
      <button type="button" 
              class="btn btn-outline" 
              (click)="showDeleteModal = false">
        H·ªßy
      </button>
      <button type="button" 
              class="btn btn-danger"
              (click)="confirmDeleteChapter()"
              [disabled]="isSubmitting">
        <span class="btn-icon">üóëÔ∏è</span>
        X√≥a ch∆∞∆°ng
      </button>
    </div>
  </div>
</div>